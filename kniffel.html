<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kniffel Online Pro</title>
    <link rel="stylesheet" href="styles_kniffel.css">
</head>
<body>

    <div id="setup" class="setup-screen">
        <h1>KNIFFEL ONLINE</h1>
        <div id="authBox" style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; width: 320px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255,215,0,0.3);">
            <p style="color: gold; font-weight: bold; font-size: 1.2em;">Willkommen!</p>
            <p>W√§hle einen Nicknamen:</p>
            <input type="text" id="userName" placeholder="z.B. Chris" style="width:90%; padding:12px; margin-bottom:15px; border-radius: 8px; border:none; font-size: 16px;">
            <button class="btn" onclick="startAnonymously()" style="width:100%; font-size: 18px; letter-spacing: 1px;">SPIEL BEITRETEN</button>
            <p id="authError" style="color: #ff6b6b; font-size: 12px; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="game" class="main-layout" style="display:none;">
        <div class="action-zone">
            <div id="pDisplay" style="font-size: 22px; color: #090866; font-weight: bold; text-shadow: 0 1px 2px rgba(255,255,255,0.5);">Warte auf Daten...</div>
            <div class="dice-grid" id="diceGrid"></div>
            <div style="font-size: 16px; margin-top: 10px;">Wurf: <span id="rollCount">0</span> / 3</div>
            <button class="btn" id="rollBtn" onclick="handleRoll()">W√úRFELN</button>
            <div id="myRoleInfo" style="font-size: 12px; color: #aaa; margin-top: 10px;"></div>
        </div>

        <div class="score-block-container" style="overflow-x: auto;">
            <table class="score-table" id="kniffelTable">
                <thead><tr id="headerRow"><th class="cat-name">Kategorien</th></tr></thead>
                <tbody id="upperBody"></tbody>
                <tbody id="upperTotals"></tbody>
                <tbody id="lowerBody"></tbody>
                <tfoot id="finalTotals"></tfoot>
            </table>

            <div id="chatContainer" style="margin-top: 20px;">
                <div id="chatBox"><i>Willkommen im Chat!</i></div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="chatInput" placeholder="Nachricht...">
                    <button class="btn" onclick="sendChatMessage()">Senden</button>
                </div>
            </div>

            <div id="leaderboardContainer" style="margin-top:30px; background: linear-gradient(145deg, #1e1e35, #16162a); border: 2px solid #ffd700; border-radius: 15px; padding: 20px; width: 100%; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; overflow: hidden; margin-left: auto; margin-right: auto;">
                <div style="position: absolute; top: -20px; right: -20px; font-size: 80px; opacity: 0.1; color: gold; transform: rotate(20deg);">üèÜ</div>
                <h3 style="color:gold; margin: 0 0 15px 0; text-align:center; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid rgba(255,215,0,0.3); padding-bottom: 10px;">
                    Hall of Fame
                </h3>
                <div id="leaderboardList" style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="text-align:center; color: #888;">Suche die besten W√ºrfler...</div>
                </div>
            </div>

            <div id="restartContainer" style="display:none; text-align:center; margin-top:20px; padding-bottom:40px;">
                <button class="btn restart-btn" onclick="resetOnlineGame()">üîÑ RAUM LEEREN</button>
                <button class="btn" onclick="signOutUser()" style="background: #444; color: white; margin-top: 10px; border: 1px solid #666;">Account wechseln</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAsznvjalpgFbi1LN1LLjJvlttZRC3NOzI",
            authDomain: "kniffelig-7af1e.firebaseapp.com",
            projectId: "kniffelig-7af1e",
            databaseURL: "https://kniffelig-7af1e-default-rtdb.europe-west1.firebasedatabase.app",
            appId: "1:1038332936720:web:9e29bb6297564fb10fc095"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const gameRef = ref(db, 'kniffel/testraum');
        const chatRef = ref(db, 'kniffel/testraum/chat');
        const highscoreRef = ref(db, 'kniffel/highscores');

        let myName, myIndex = null, gameState = null, currentUser = null;

        const upperCats = [
            { id: '1', n: 'Einser', v: 1 }, { id: '2', n: 'Zweier', v: 2 },
            { id: '3', n: 'Dreier', v: 3 }, { id: '4', n: 'Vierer', v: 4 },
            { id: '5', n: 'F√ºnfer', v: 5 }, { id: '6', n: 'Sechser', v: 6 }
        ];
        const lowerCats = [
            { id: '3p', n: '3er-Pasch' }, { id: '4p', n: '4er-Pasch' },
            { id: 'fh', n: 'Full House' }, { id: 'ks', n: 'Kl. Stra√üe' },
            { id: 'gs', n: 'Gr. Stra√üe' }, { id: 'kn', n: 'Kniffel' }, { id: 'ch', n: 'Chance' }
        ];

        window.startAnonymously = async function() {
            const name = document.getElementById('userName').value.trim();
            const errorEl = document.getElementById('authError');
            if(!name) return errorEl.innerText = "Bitte Namen eingeben!";
            try {
                const userCredential = await signInAnonymously(auth);
                await updateProfile(userCredential.user, { displayName: name });
            } catch (error) {
                errorEl.innerText = "Fehler: " + error.message;
            }
        };

        window.signOutUser = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user && user.displayName) {
                currentUser = user;
                myName = user.displayName;
                initOnlineGame();
                loadLeaderboard();
            } else {
                document.getElementById('setup').style.display = 'flex';
                document.getElementById('game').style.display = 'none';
            }
        });

        function loadLeaderboard() {
            onValue(highscoreRef, (snapshot) => {
                const data = snapshot.val();
                const listEl = document.getElementById('leaderboardList');
                if(!data) return listEl.innerHTML = "<div style='text-align:center;'>Noch keine Helden eingetragen.</div>";
                
                const sorted = Object.values(data).sort((a,b) => b.score - a.score).slice(0, 5);
                
                listEl.innerHTML = sorted.map((entry, i) => {
                    let medal = "";
                    let bgColor = "rgba(255,255,255,0.05)";
                    let textColor = "white";
                    if(i === 0) { medal = "ü•á "; bgColor = "rgba(255, 215, 0, 0.15)"; textColor = "#ffd700"; }
                    if(i === 1) medal = "ü•à ";
                    if(i === 2) medal = "ü•â ";

                    return `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 15px; background: ${bgColor}; border-radius: 8px; border-left: 4px solid ${i === 0 ? 'gold' : '#444'};">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span style="font-weight:bold; color: ${textColor}; width: 25px;">${medal || (i+1 + ". ")}</span>
                                <span style="font-weight: ${i === 0 ? 'bold' : 'normal'}; color: ${textColor};">${entry.name}</span>
                            </div>
                            <div style="text-align:right;">
                                <div style="color:gold; font-weight:bold; font-size: 1.1em;">${entry.score} <small style="font-size: 0.7em;">PKT</small></div>
                                <div style="font-size: 0.7em; color: #888;">${entry.date || ""}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        async function saveMyResult() {
            if (!currentUser || myIndex === null) return;
            const p = gameState.players[myIndex];
            const upSum = upperCats.reduce((s, c) => s + (p.scores && p.scores[c.id] ? p.scores[c.id] : 0), 0);
            const loSum = lowerCats.reduce((s, c) => s + (p.scores && p.scores[c.id] ? p.scores[c.id] : 0), 0);
            const bonus = upSum >= 63 ? 35 : 0;
            const finalScore = upSum + bonus + loSum;

            const userScoreRef = ref(db, 'kniffel/highscores/' + currentUser.uid);
            const snapshot = await get(userScoreRef);
            const currentRecord = snapshot.exists() ? snapshot.val().score : 0;

            if (finalScore > currentRecord) {
                update(userScoreRef, { name: myName, score: finalScore, date: new Date().toLocaleDateString() });
                push(chatRef, { user: "SYSTEM", text: `üåü NEUER PERS√ñNLICHER REKORD: ${myName} hat ${finalScore} Punkte erreicht!` });
            }
        }

        window.initOnlineGame = function() {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'flex';
            onValue(gameRef, (snapshot) => {
                const data = snapshot.val();
                if(!data) {
                    const initial = { players: [{ name: myName, scores: {} }], activePlayer: 0, dice: [0,0,0,0,0], keeps: [false,false,false,false,false], rolls: 0 };
                    set(gameRef, initial);
                    myIndex = 0;
                    gameState = initial;
                } else {
                    gameState = data;
                    if(myIndex === null) {
                        let idx = data.players.findIndex(p => p.name === myName);
                        if(idx !== -1) myIndex = idx;
                        else {
                            myIndex = data.players.length;
                            const newP = [...data.players, { name: myName, scores: {} }];
                            update(gameRef, { players: newP });
                        }
                    }
                    if(data.chat) {
                        const chatBox = document.getElementById('chatBox');
                        chatBox.innerHTML = '';
                        Object.values(data.chat).slice(-15).forEach(msg => {
                            chatBox.innerHTML += `<div><b>${msg.user}:</b> ${msg.text}</div>`;
                        });
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }
                syncUI();
            });
            createDiceElements();
        };

        function syncUI() {
            if(!gameState || !gameState.players) return;
            const hRow = document.getElementById('headerRow');
            hRow.innerHTML = '<th class="cat-name">Kategorien</th>';
            gameState.players.forEach((p, i) => {
                const th = document.createElement('th');
                th.innerText = p.name;
                if(i === gameState.activePlayer) th.style.backgroundColor = "rgba(255, 215, 0, 0.2)";
                hRow.appendChild(th);
            });
            gameState.dice.forEach((val, i) => {
                const dieEl = document.getElementById('die' + i);
                if(!dieEl) return;
                dieEl.className = gameState.keeps[i] ? 'die keep' : 'die';
                dieEl.style.backgroundImage = val > 0 ? `url('wuerfel${val}.png')` : "none";
            });
            document.getElementById('pDisplay').innerText = gameState.players[gameState.activePlayer].name + " ist dran";
            document.getElementById('rollCount').innerText = gameState.rolls;
            document.getElementById('myRoleInfo').innerText = "Angemeldet als: " + myName;
            renderSection('upperBody', upperCats);
            renderSection('lowerBody', lowerCats);
            renderSums();
            checkGameOver();
        }

        function renderSection(tbodyId, cats) {
            const body = document.getElementById(tbodyId);
            body.innerHTML = '';
            cats.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="cat-name">${c.n}</td>`;
                gameState.players.forEach((p, i) => {
                    const td = document.createElement('td');
                    const score = (p.scores && p.scores[c.id] !== undefined) ? p.scores[c.id] : null;
                    if(score !== null) {
                        td.innerHTML = `<span class="filled">${score}</span>`;
                    } else if(i === gameState.activePlayer && i === myIndex && gameState.rolls > 0) {
                        const val = calculatePoints(c.id, gameState.dice, c.v);
                        const span = document.createElement('span');
                        span.className = 'preview'; span.innerText = val;
                        span.onclick = () => selectScore(c.id, val);
                        td.appendChild(span);
                    }
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
        }

        function renderSums() {
            const upTotal = document.getElementById('upperTotals'); upTotal.innerHTML = '';
            const finalTotal = document.getElementById('finalTotals'); finalTotal.innerHTML = '';
            const rowsUpper = [
                { label: "Punkte oben", type: "sum" },
                { label: "Bonus (ab 63 Pkte)", type: "bonus" },
                { label: "Gesamtpunkte oben", type: "totalUp" }
            ];
            rowsUpper.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="cat-name">${row.label}</td>`;
                gameState.players.forEach(p => {
                    const sum = upperCats.reduce((s, c) => s + (p.scores && p.scores[c.id] ? p.scores[c.id] : 0), 0);
                    const bonus = sum >= 63 ? 35 : 0;
                    let val = (row.type === "sum") ? sum : (row.type === "bonus" ? bonus : sum + bonus);
                    tr.innerHTML += `<td>${val}</td>`;
                });
                upTotal.appendChild(tr);
            });
            const rowsFinal = [
                { label: "Gesamtpunkte unten", type: "sumLow" },
                { label: "Gesamtpunkte oben", type: "sumUpAll" },
                { label: "GESAMTPUNKTE", type: "grand" }
            ];
            rowsFinal.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="cat-name"><b>${row.label}</b></td>`;
                gameState.players.forEach(p => {
                    const upSum = upperCats.reduce((s, c) => s + (p.scores && p.scores[c.id] ? p.scores[c.id] : 0), 0);
                    const loSum = lowerCats.reduce((s, c) => s + (p.scores && p.scores[c.id] ? p.scores[c.id] : 0), 0);
                    const bonus = upSum >= 63 ? 35 : 0;
                    let val = row.type === "sumLow" ? loSum : (row.type === "sumUpAll" ? upSum + bonus : upSum + bonus + loSum);
                    tr.innerHTML += `<td><b>${val}</b></td>`;
                });
                finalTotal.appendChild(tr);
            });
        }

        window.sendChatMessage = function() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(text !== "") { push(chatRef, { user: myName, text: text }); input.value = ''; }
        };

        window.handleRoll = function() {
            if(!gameState || myIndex !== gameState.activePlayer) return;
            let newDice = [...gameState.dice];
            for(let i=0; i<5; i++) if(!gameState.keeps[i]) newDice[i] = Math.floor(Math.random()*6)+1;
            update(gameRef, { dice: newDice, rolls: gameState.rolls + 1 });
        };

        function toggleKeep(i) {
            if(!gameState || myIndex !== gameState.activePlayer || gameState.rolls === 0) return;
            let newKeeps = [...gameState.keeps];
            newKeeps[i] = !newKeeps[i];
            update(gameRef, { keeps: newKeeps });
        }

        window.selectScore = function(catId, value) {
            let updates = {};
            updates[`players/${myIndex}/scores/${catId}`] = value;
            updates[`activePlayer`] = (gameState.activePlayer + 1) % gameState.players.length;
            updates[`rolls`] = 0; updates[`dice`] = [0,0,0,0,0]; updates[`keeps`] = [false,false,false,false,false];
            update(gameRef, updates);
        };

        function calculatePoints(id, d, v) {
            if(v) return d.filter(x => x === v).length * v;
            const counts = {}; d.forEach(x => counts[x] = (counts[x]||0)+1);
            const vals = Object.values(counts); const sum = d.reduce((a,b)=>a+b,0);
            if(id === '3p') return vals.some(x => x >= 3) ? sum : 0;
            if(id === '4p') return vals.some(x => x >= 4) ? sum : 0;
            if(id === 'fh') return vals.includes(2) && vals.includes(3) ? 25 : 0;
            if(id === 'kn') return vals.includes(5) ? 50 : 0;
            if(id === 'ch') return sum;
            const s = [...new Set(d)].sort().join('');
            if(id === 'ks') return /1234|2345|3456/.test(s) ? 30 : 0;
            if(id === 'gs') return /12345|23456/.test(s) ? 40 : 0;
            return 0;
        }

        function createDiceElements() {
            const grid = document.getElementById('diceGrid'); grid.innerHTML = '';
            for(let i=0; i<5; i++) {
                const d = document.createElement('div'); d.className = 'die'; d.id = 'die' + i;
                d.onclick = () => toggleKeep(i); grid.appendChild(d);
            }
        }

        function checkGameOver() {
            if(!gameState || !gameState.players) return;
            const allFilled = gameState.players.every(p => p.scores && Object.keys(p.scores).length === 13);
            if(allFilled && document.getElementById('restartContainer').style.display === 'none') {
                document.getElementById('restartContainer').style.display = 'block';
                saveMyResult();
            }
        }

        window.resetOnlineGame = function() {
            if(confirm("Den gesamten Spielraum f√ºr alle leeren?")) { set(gameRef, null); location.reload(); }
        };
    </script>
</body>
</html>
