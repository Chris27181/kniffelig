<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Kniffel Deluxe - Image Version</title>
<link rel="stylesheet" href="styles_kniffel.css">
</head>
<body>

    <div id="setup" class="setup-screen">
        <h1>KNIFFEL ONLINE</h1>
        <div id="playerSetup">
            <p>Dein Nickname:</p>
            <input type="text" id="userName" placeholder="z.B. Chris" style="padding:10px; font-size:18px; border-radius:5px; width:220px;">
            <br><br>
            <button class="btn" onclick="initOnlineGame()">Dem Spiel beitreten</button>
        </div>
    </div>

    <div id="game" class="main-layout" style="display:none;">
        <div class="action-zone">
            <div id="pDisplay" style="font-size: 22px; color: gold; font-weight: bold;">Warte auf Daten...</div>
            <div class="dice-grid" id="diceGrid"></div>
            <div style="font-size: 16px; margin-top: 10px;">Wurf: <span id="rollCount">0</span> / 3</div>
            <button class="btn" id="rollBtn" onclick="handleRoll()">WÃœRFELN</button>
            <div id="myRoleInfo" style="font-size: 12px; color: #777; margin-top: 10px;"></div>
        </div>

        <div class="score-block-container">
            <table class="score-table" id="kniffelTable" style="width: 100%; border-collapse: collapse;">
                <thead><tr id="headerRow"><th class="cat-name">Kategorien</th></tr></thead>
                <tbody id="upperBody"></tbody>
                <tbody id="upperTotals"></tbody>
                <tbody id="lowerBody"></tbody>
                <tfoot id="finalTotals"></tfoot>
            </table>
            
            <div id="chatContainer" style="margin-top:20px; background: #1a1a2e; border: 1px solid #444; border-radius: 8px; padding: 10px;">
                <div id="chatBox" style="height: 150px; overflow-y: auto; color: white; font-size: 14px; text-align: left; margin-bottom: 10px; padding: 5px; background: #0f0f1a;">
                    <i>Willkommen im Chat!</i>
                </div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="chatInput" placeholder="Nachricht..." style="flex: 1; padding: 8px; border-radius: 4px; border: none;">
                    <button class="btn" onclick="sendChatMessage()" style="padding: 8px 15px;">Senden</button>
                </div>
            </div>

            <div id="restartContainer" style="display:none; text-align:center; margin-top:20px; padding-bottom:40px;">
                <button class="btn restart-btn" onclick="resetOnlineGame()">ðŸ”„ RAUM LEEREN</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAsznvjalpgFbi1LN1LLjJvlttZRC3NOzI",
            authDomain: "kniffelig-7af1e.firebaseapp.com",
            projectId: "kniffelig-7af1e",
            databaseURL: "https://kniffelig-7af1e-default-rtdb.europe-west1.firebasedatabase.app",
            appId: "1:1038332936720:web:9e29bb6297564fb10fc095"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const gameRef = ref(db, 'kniffel/testraum');
        const chatRef = ref(db, 'kniffel/testraum/chat'); // Pfad fÃ¼r den Chat

        let myName, myIndex = null, gameState = null;

        const upperCats = [
            { id: '1', n: 'Einser', v: 1 }, { id: '2', n: 'Zweier', v: 2 },
            { id: '3', n: 'Dreier', v: 3 }, { id: '4', n: 'Vierer', v: 4 },
            { id: '5', n: 'FÃ¼nfer', v: 5 }, { id: '6', n: 'Sechser', v: 6 }
        ];
        const lowerCats = [
            { id: '3p', n: '3er-Pasch' }, { id: '4p', n: '4er-Pasch' },
            { id: 'fh', n: 'Full House' }, { id: 'ks', n: 'Kl. StraÃŸe' },
            { id: 'gs', n: 'Gr. StraÃŸe' }, { id: 'kn', n: 'Kniffel' }, { id: 'ch', n: 'Chance' }
        ];

        window.initOnlineGame = function() {
            myName = document.getElementById('userName').value.trim();
            if(!myName) return alert("Name fehlt!");

            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'flex';

            onValue(gameRef, (snapshot) => {
                const data = snapshot.val();
                if(!data) {
                    const initial = { players: [{ name: myName, scores: {} }], activePlayer: 0, dice: [0,0,0,0,0], keeps: [false,false,false,false,false], rolls: 0 };
                    set(gameRef, initial);
                    myIndex = 0;
                    gameState = initial;
                } else {
                    gameState = data;
                    if(myIndex === null) {
                        let idx = data.players.findIndex(p => p.name === myName);
                        if(idx !== -1) myIndex = idx;
                        else {
                            myIndex = data.players.length;
                            const newP = [...data.players, { name: myName, scores: {} }];
                            update(gameRef, { players: newP });
                        }
                    }
                    // Chat-Nachrichten anzeigen
                    if(data.chat) {
                        const chatBox = document.getElementById('chatBox');
                        chatBox.innerHTML = '';
                        Object.values(data.chat).slice(-10).forEach(msg => { // Zeige nur die letzten 10 Nachrichten
                            chatBox.innerHTML += `<div><b>${msg.user}:</b> ${msg.text}</div>`;
                        });
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }
                syncUI();
            });

            createDiceElements();
        };

        // CHAT SENDEN FUNKTION
        window.sendChatMessage = function() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(text !== "") {
                push(chatRef, { user: myName, text: text });
                input.value = '';
            }
        };

        // Enter-Taste zum Senden erlauben
        document.addEventListener('keypress', (e) => {
            if(e.key === 'Enter' && document.activeElement.id === 'chatInput') {
                sendChatMessage();
            }
        });

        function createDiceElements() {
            const grid = document.getElementById('diceGrid');
            grid.innerHTML = '';
            for(let i=0; i<5; i++) {
                const d = document.createElement('div');
                d.className = 'die'; d.id = 'die' + i;
                d.onclick = () => toggleKeep(i);
                grid.appendChild(d);
            }
        }

        function syncUI() {
            if(!gameState || !gameState.players) return;
            const hRow = document.getElementById('headerRow');
            hRow.innerHTML = '<th class="cat-name">Kategorien</th>';
            gameState.players.forEach((p, i) => {
                const th = document.createElement('th');
                th.innerText = p.name;
                if(i === gameState.activePlayer) th.style.backgroundColor = "rgba(255, 215, 0, 0.2)";
                hRow.appendChild(th);
            });
            gameState.dice.forEach((val, i) => {
                const dieEl = document.getElementById('die' + i);
                if(!dieEl) return;
                dieEl.className = gameState.keeps[i] ? 'die keep' : 'die';
                dieEl.style.backgroundImage = val > 0 ? `url('wuerfel${val}.png')` : "none";
            });
            document.getElementById('pDisplay').innerText = gameState.players[gameState.activePlayer].name + " ist dran";
            document.getElementById('rollBtn').disabled = (gameState.activePlayer !== myIndex || gameState.rolls >= 3);
            renderSection('upperBody', upperCats);
            renderSection('lowerBody', lowerCats);
            renderSums();
        }

        function renderSection(tbodyId, cats) {
            const body = document.getElementById(tbodyId);
            body.innerHTML = '';
            cats.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="cat-name">${c.n}</td>`;
                gameState.players.forEach((p, i) => {
                    const td = document.createElement('td');
                    const score = (p.scores && p.scores[c.id] !== undefined) ? p.scores[c.id] : null;
                    if(score !== null) {
                        td.innerHTML = `<span class="filled">${score}</span>`;
                    } else if(i === gameState.activePlayer && i === myIndex && gameState.rolls > 0) {
                        const val = calculatePoints(c.id, gameState.dice, c.v);
                        const span = document.createElement('span');
                        span.className = 'preview';
                        span.innerText = val;
                        span.onclick = () => selectScore(c.id, val);
                        td.appendChild(span);
                    }
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
        }

        function renderSums() {
            const upTotal = document.getElementById('upperTotals'); upTotal.innerHTML = '';
            const finalTotal = document.getElementById('finalTotals'); finalTotal.innerHTML = '';
            const trUpper = document.createElement('tr');
            trUpper.innerHTML = `<td class="cat-name">Gesamt Oben</td>`;
            const trFinal = document.createElement('tr');
            trFinal.innerHTML = `<td class="cat-name">GESAMT</td>`;
            gameState.players.forEach((p, i) => {
                const upSum = upperCats.reduce((s, c) => s + (p.scores && p.scores[c.id] ? p.scores[c.id] : 0), 0);
                const bonus = upSum >= 63 ? 35 : 0;
                const loSum = lowerCats.reduce((s, c) => s + (p.scores && p.scores[c.id] ? p.scores[c.id] : 0), 0);
                const tdU = document.createElement('td'); tdU.innerText = upSum + bonus;
                trUpper.appendChild(tdU);
                const tdF = document.createElement('td'); tdF.innerText = upSum + bonus + loSum;
                trFinal.appendChild(tdF);
            });
            upTotal.appendChild(trUpper);
            finalTotal.appendChild(trFinal);
        }

        window.handleRoll = function() {
            if(!gameState || myIndex !== gameState.activePlayer) return;
            let newDice = [...gameState.dice];
            for(let i=0; i<5; i++) if(!gameState.keeps[i]) newDice[i] = Math.floor(Math.random()*6)+1;
            update(gameRef, { dice: newDice, rolls: gameState.rolls + 1 });
        };

        function toggleKeep(i) {
            if(!gameState || myIndex !== gameState.activePlayer || gameState.rolls === 0) return;
            let newKeeps = [...gameState.keeps];
            newKeeps[i] = !newKeeps[i];
            update(gameRef, { keeps: newKeeps });
        }

        window.selectScore = function(catId, value) {
            let updates = {};
            updates[`players/${myIndex}/scores/${catId}`] = value;
            updates[`activePlayer`] = (gameState.activePlayer + 1) % gameState.players.length;
            updates[`rolls`] = 0; updates[`dice`] = [0,0,0,0,0]; updates[`keeps`] = [false,false,false,false,false];
            update(gameRef, updates);
        };

        function calculatePoints(id, d, v) {
            if(v) return d.filter(x => x === v).length * v;
            const counts = {}; d.forEach(x => counts[x] = (counts[x]||0)+1);
            const vals = Object.values(counts); const sum = d.reduce((a,b)=>a+b,0);
            if(id === '3p') return vals.some(x => x >= 3) ? sum : 0;
            if(id === '4p') return vals.some(x => x >= 4) ? sum : 0;
            if(id === 'fh') return vals.includes(2) && vals.includes(3) ? 25 : 0;
            if(id === 'kn') return vals.includes(5) ? 50 : 0;
            if(id === 'ch') return sum;
            const s = [...new Set(d)].sort().join('');
            if(id === 'ks') return /1234|2345|3456/.test(s) ? 30 : 0;
            if(id === 'gs') return /12345|23456/.test(s) ? 40 : 0;
            return 0;
        }

        window.resetOnlineGame = function() {
            if(confirm("LÃ¶schen?")) { set(gameRef, null); location.reload(); }
        };
    </script>
</body>
</html>
